<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gustave - API PDF</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.10.3/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen" x-data="pdfApp()">
    <header class="bg-indigo-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-3xl font-bold">Gustave PDF</h1>
            <p class="text-indigo-200">Extraction et analyse de tableaux PDF</p>
        </div>
    </header>

    <main class="container mx-auto p-4 my-8">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                <h2 class="text-2xl font-semibold">Sélectionnez votre fichier PDF</h2>
            </div>

            <form @submit.prevent="submitForm" class="space-y-4">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center" 
                     @dragover.prevent="dragOver = true" 
                     @dragleave.prevent="dragOver = false" 
                     @drop.prevent="handleFileDrop($event)"
                     :class="{'bg-indigo-50 border-indigo-300': dragOver}">
                    <div x-show="!fileSelected">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p class="text-gray-700 mb-2">Glissez-déposez votre fichier PDF ici</p>
                        <p class="text-gray-500 text-sm mb-4">ou</p>
                        <label class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 cursor-pointer">
                            Parcourir...
                            <input type="file" accept=".pdf" class="hidden" @change="handleFileSelect($event)">
                        </label>
                    </div>
                    <div x-show="fileSelected" class="flex items-center justify-center space-x-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <div class="flex-1 truncate">
                            <p class="font-medium text-gray-900 truncate" x-text="selectedFile.name"></p>
                            <p class="text-sm text-gray-500" x-text="formatFileSize(selectedFile.size)"></p>
                        </div>
                        <button type="button" @click="resetFile" class="text-gray-500 hover:text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Options d'extraction -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Type de document</label>
                        <select x-model="documentType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
							<option value="auto">Auto-détection</option>
							<option value="generic">Générique</option>
							<option value="invoice">Facture</option>
							<option value="receipt">Reçu</option>
							<option value="devis">Devis technique</option>
						</select>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Pages</label>
                        <input type="text" x-model="pages" placeholder="all, 1, 1-3, 1,3,5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Stratégie d'extraction</label>
                        <select x-model="strategy" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="auto">Auto-détection</option>
                            <option value="tabula">Tabula</option>
                            <option value="camelot">Camelot</option>
                            <option value="pdfplumber">PDFPlumber</option>
                            <option value="ocr">OCR (PDF scanné)</option>
							<option value="ai">IA</option>
							<option value="hybrid">Hybride</option>
							<option value="enhanced">Amélioré</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Format de sortie</label>
                        <select x-model="outputFormat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="html">HTML</option>
                            <option value="excel">Excel</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Options OCR -->
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="ocrEnabled" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Activer l'OCR pour les PDF scannés</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="includeImages" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Inclure les images des tableaux</span>
                        </label>
                    </div>
                </div>

                <!-- Options OCR supplémentaires -->
                <div x-show="ocrEnabled" class="grid grid-cols-1 md:grid-cols-3 gap-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Langues OCR</label>
                        <select x-model="ocrLanguage" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="fra">Français</option>
                            <option value="eng">Anglais</option>
                            <option value="fra+eng">Français + Anglais</option>
                            <option value="deu">Allemand</option>
                            <option value="spa">Espagnol</option>
                            <option value="ita">Italien</option>
                        </select>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="ocrEnhanceImage" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Améliorer l'image (contraste)</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="ocrDeskew" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Corriger l'inclinaison</span>
                        </label>
                    </div>
                </div>

                <!-- Options avancées -->
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="font-medium text-gray-700 mb-2">Options avancées</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="analyze" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <span class="ml-2 text-gray-700">Analyser les tableaux</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="backgroundProcessing" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <span class="ml-2 text-gray-700">Traitement en arrière-plan</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="extractCheckboxes" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <span class="ml-2 text-gray-700">Extraire les cases à cocher</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Options supplémentaires -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="useCache" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <span class="ml-2 text-gray-700">Utiliser le cache</span>
                            </label>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Format de téléchargement</label>
                            <select x-model="downloadFormat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Aucun</option>
                                <option value="csv">CSV</option>
                                <option value="excel">Excel</option>
                                <option value="json">JSON</option>
                                <option value="html">HTML</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Recherche dans les tableaux -->
                    <div class="mt-4" x-show="analyze">
                        <label class="block text-gray-700 font-medium mb-2">Rechercher dans les tableaux</label>
                        <input type="text" x-model="searchQuery" placeholder="Entrez votre recherche..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" @click="resetForm" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Réinitialiser
                    </button>
                    <button type="submit" :disabled="isLoading || !fileSelected" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                        <svg x-show="isLoading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-show="!isLoading">Extraire les tableaux</span>
                        <span x-show="isLoading">Traitement en cours...</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Message d'erreur -->
        <div x-show="error" class="bg-red-50 border-l-4 border-red-500 p-4 mb-8">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700" x-text="error"></p>
                </div>
            </div>
        </div>

        <!-- Résultats -->
        <div x-show="results !== null" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Résultats
            </h2>

            <!-- Indication si OCR a été utilisé -->
            <div x-show="results.ocr_used" class="mb-4 p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">L'OCR a été utilisé pour l'extraction des tableaux de ce PDF scanné.</p>
                    </div>
                </div>
            </div>

            <!-- Extrait des infos de base -->
            <div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Fichier</p>
                    <p class="font-medium text-gray-900" x-text="results.filename || 'N/A'"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Taille</p>
                    <p class="font-medium text-gray-900" x-text="results.file_size ? formatFileSize(results.file_size) : 'N/A'"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Temps de traitement</p>
                    <p class="font-medium text-gray-900" x-text="results.processing_time ? `${results.processing_time.toFixed(2)}s` : 'N/A'"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Tableaux trouvés</p>
                    <p class="font-medium text-gray-900" x-text="results.tables_count || results.tables?.length || 'N/A'"></p>
                </div>
            </div>

            <!-- Méthode d'extraction utilisée -->
            <div x-show="results.extraction_method_used" class="mb-4 flex items-center p-3 bg-gray-50 rounded-lg">
                <div class="mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-700">
                        Méthode d'extraction utilisée :
                        <span class="font-semibold" x-text="results.extraction_method_used"></span>
                    </p>
                </div>
            </div>

            <!-- Cases à cocher extraites -->
            <div x-show="results.checkboxes" class="my-8 border-t pt-8">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Cases à cocher extraites
                </h3>
                
                <!-- Métadonnées d'extraction -->
                <div class="mb-4 bg-gray-50 p-3 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="space-y-1">
                            <p class="text-sm text-gray-500">Nombre de pages traitées</p>
                            <p class="font-medium" x-text="results.checkboxes.metadata?.processed_pages || 'N/A'"></p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-sm text-gray-500">Nombre de cases trouvées</p>
                            <p class="font-medium" x-text="results.checkboxes.checkboxes?.length || 'N/A'"></p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-sm text-gray-500">Date d'extraction</p>
                            <p class="font-medium" x-text="results.checkboxes.metadata?.extraction_date || 'N/A'"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Tableau des cases à cocher par section -->
                <div x-show="results.checkboxes && results.checkboxes.sections">
                    <template x-for="(checkboxes, section) in results.checkboxes.sections" :key="section">
                        <div class="mb-6">
                            <h4 class="font-medium text-lg mb-3" x-text="section"></h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Libellé</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valeur</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cochée</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Page</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="(checkbox, idx) in checkboxes" :key="idx">
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="checkbox.label"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="checkbox.value"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                    <span x-show="checkbox.checked" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                        Oui
                                                    </span>
                                                    <span x-show="!checkbox.checked" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                                        Non
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="checkbox.page"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Si aucune section n'est définie, afficher toutes les cases -->
                <div x-show="results.checkboxes && results.checkboxes.checkboxes && (!results.checkboxes.sections || Object.keys(results.checkboxes.sections).length === 0)">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Libellé</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valeur</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cochée</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Section</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Page</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="(checkbox, idx) in results.checkboxes.checkboxes" :key="idx">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="checkbox.label"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="checkbox.value"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <span x-show="checkbox.checked" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                Oui
                                            </span>
                                            <span x-show="!checkbox.checked" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                                Non
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="checkbox.section"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="checkbox.page"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Si aucune case à cocher n'a été trouvée -->
                <div x-show="results.checkboxes && (!results.checkboxes.checkboxes || results.checkboxes.checkboxes.length === 0)" class="p-4 bg-indigo-50 rounded-lg text-center text-gray-600">
                    Aucune case à cocher n'a été détectée dans ce document.
                </div>
            </div>

            <!-- Tableaux de résultats -->
            <div x-show="results.tables && results.tables.length > 0" class="overflow-x-auto">
                <template x-for="(table, tableIndex) in results.tables" :key="tableIndex">
                    <div class="mb-6 border rounded-lg overflow-hidden">
                        <div class="flex justify-between items-center p-4 bg-gray-50 border-b">
                            <h3 class="font-semibold" x-text="`Tableau ${tableIndex + 1}`"></h3>
                            <div class="flex items-center">
                                <span class="text-sm text-gray-600" x-text="`Page: ${table.page || 'N/A'}`"></span>
                                <span class="ml-4 text-sm text-gray-600" x-text="`Lignes: ${table.rows || 'N/A'}`"></span>
                                <span class="ml-4 text-sm text-gray-600" x-text="`Colonnes: ${table.columns || 'N/A'}`"></span>
                                <button @click="downloadTableData(table, tableIndex)" class="ml-4 px-3 py-1 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Télécharger
                                </button>
                            </div>
                        </div>
                        <div class="p-4 overflow-x-auto">
                            <!-- Affichage pour le format HTML -->
                            <div x-show="outputFormat === 'html'" x-html="table.data"></div>
                            
                            <!-- Affichage pour JSON et autres formats -->
                            <pre x-show="outputFormat !== 'html'" class="text-sm whitespace-pre-wrap bg-gray-50 p-4 rounded" x-text="typeof table.data === 'object' ? JSON.stringify(table.data, null, 2) : table.data"></pre>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Aucun tableau trouvé -->
            <div x-show="results.tables && results.tables.length === 0" class="p-4 border rounded-lg mb-4 bg-indigo-50">
                Aucun tableau n'a été trouvé dans le document.
            </div>

            <!-- Analyse de tableau -->
            <div x-show="results.analysis" class="space-y-6 mt-8 border-t pt-8">
                <h3 class="text-xl font-semibold mb-4">Analyse des tableaux</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-500">Total tableaux</p>
                        <p class="font-medium text-gray-900" x-text="results.analysis.table_count || 'N/A'"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-500">Total lignes</p>
                        <p class="font-medium text-gray-900" x-text="results.analysis.total_rows || 'N/A'"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-500">Moyenne lignes/tableau</p>
                        <p class="font-medium text-gray-900" x-text="results.analysis.average_row_count || 'N/A'"></p>
                    </div>
                </div>
                
                <!-- Tableaux détaillés -->
                <div x-show="results.analysis.tables && results.analysis.tables.length > 0">
                    <h4 class="text-lg font-medium mb-3">Détails par tableau</h4>
                    <div class="space-y-4">
                        <template x-for="(tableAnalysis, index) in results.analysis.tables" :key="index">
                            <div class="border rounded-lg overflow-hidden">
                                <div class="bg-gray-50 p-4 border-b">
                                    <h5 class="font-medium" x-text="`Tableau ${tableAnalysis.table_id}`"></h5>
                                    <div class="flex space-x-4 text-sm text-gray-500 mt-1">
                                        <span x-text="`Lignes: ${tableAnalysis.rows}`"></span>
                                        <span x-text="`Colonnes: ${tableAnalysis.columns}`"></span>
                                        <span x-text="`Cellules vides: ${tableAnalysis.null_percentage}%`"></span>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <p class="font-medium mb-2">Colonnes numériques: <span x-text="tableAnalysis.numeric_columns_count"></span></p>
                                    <div x-show="tableAnalysis.numeric_stats && Object.keys(tableAnalysis.numeric_stats).length > 0">
                                        <p class="font-medium mb-1">Statistiques numériques:</p>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                                            <template x-for="(stats, colName) in tableAnalysis.numeric_stats" :key="colName">
                                                <div class="bg-gray-50 p-3 rounded">
                                                    <p class="font-medium" x-text="colName"></p>
                                                    <p class="text-sm text-gray-600" x-text="`Min: ${stats.min !== null ? stats.min : 'N/A'}, Max: ${stats.max !== null ? stats.max : 'N/A'}`"></p>
                                                    <p class="text-sm text-gray-600" x-text="`Moyenne: ${stats.mean !== null ? stats.mean : 'N/A'}, Médiane: ${stats.median !== null ? stats.median : 'N/A'}`"></p>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Résultats de recherche -->
            <div x-show="results.search_results" class="space-y-6 mt-8 border-t pt-8">
                <h3 class="text-xl font-semibold mb-4">Résultats de recherche</h3>
                
                <div class="p-4 bg-indigo-50 rounded-lg mb-4">
                    <p class="font-medium">Recherche de: <span class="font-bold" x-text="results.search_results.query"></span></p>
                    <p class="text-sm mt-1">
                        <span x-text="`${results.search_results.matching_tables} tableaux correspondants`"></span>
                        <span class="ml-4" x-text="`${results.search_results.total_matches} correspondances trouvées`"></span>
                    </p>
                </div>

                <div x-show="results.search_results.results && results.search_results.results.length === 0" class="p-4 border rounded-lg">
                    Aucune correspondance trouvée.
                </div>

                <template x-for="(tableResult, resultIndex) in results.search_results.results" :key="resultIndex">
                    <div class="border rounded-lg overflow-hidden mb-4">
                        <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                            <h3 class="font-medium" x-text="`Tableau ${tableResult.table_id}`"></h3>
                            <span class="text-sm text-gray-600" x-text="`Page ${tableResult.page} · ${tableResult.matches_count} correspondances`"></span>
                        </div>
                        <div class="p-4">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ligne</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Colonne</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valeur</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="(match, matchIndex) in tableResult.matches" :key="matchIndex">
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="match.row + 1"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="match.column"></td>
                                                <td class="px-6 py-4 text-sm text-gray-800" x-text="match.value"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Données structurées de facture -->
            <div x-show="results.structured_data" class="space-y-6 mt-8 border-t pt-8">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Données structurées de facture
                </h3>
                
                <!-- Info sur le score de confiance -->
                <div class="bg-blue-50 p-4 rounded-lg mb-6" x-show="results.structured_data.metadata">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-blue-800">
                            <span>Type détecté: <span class="font-semibold" x-text="results.structured_data.metadata?.document_subtype || 'générique'"></span></span>
                            <span class="ml-4">Confiance: <span class="font-semibold" x-text="results.structured_data.metadata?.confidence ? (results.structured_data.metadata.confidence * 100).toFixed(0) + '%' : 'N/A'"></span></span>
                        </p>
                    </div>
                </div>
                
                <!-- Informations générales de facture -->
                <div class="bg-white rounded-lg border shadow-sm p-4 mb-6" x-show="results.structured_data.invoice_info">
                    <h4 class="font-semibold text-lg mb-3 text-gray-700">Informations de facture</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="space-y-1">
                            <p class="text-sm text-gray-500">Numéro de facture</p>
                            <p class="font-medium" x-text="results.structured_data.invoice_info.number || 'N/A'"></p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-sm text-gray-500">Date</p>
                            <p class="font-medium" x-text="results.structured_data.invoice_info.date || 'N/A'"></p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-sm text-gray-500">Fournisseur</p>
                            <p class="font-medium" x-text="results.structured_data.invoice_info.vendor || 'N/A'"></p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-sm text-gray-500">Numéro TVA</p>
                            <p class="font-medium" x-text="results.structured_data.invoice_info.vat_number || 'N/A'"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Lignes de facture -->
                <div class="bg-white rounded-lg border shadow-sm p-4 mb-6" x-show="results.structured_data.line_items && results.structured_data.line_items.length > 0">
                    <h4 class="font-semibold text-lg mb-3 text-gray-700">Lignes de facturation</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prix unitaire</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="(item, index) in results.structured_data.line_items" :key="index">
                                    <tr>
                                        <td class="px-6 py-4 text-sm text-gray-700" x-text="item.description || 'N/A'"></td>
                                        <td class="px-6 py-4 text-sm text-gray-700" x-text="item.quantity || 'N/A'"></td>
                                        <td class="px-6 py-4 text-sm text-gray-700" x-text="item.unit_price ? item.unit_price.toFixed(2) + ' €' : 'N/A'"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium" x-text="item.amount ? item.amount.toFixed(2) + ' €' : 'N/A'"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Totaux de facture -->
                <div class="bg-white rounded-lg border shadow-sm p-4" x-show="results.structured_data.totals">
                    <h4 class="font-semibold text-lg mb-3 text-gray-700">Totaux</h4>
                    <div class="bg-gray-50 p-4 rounded-lg max-w-md ml-auto">
                        <div class="flex justify-between py-2 border-b border-gray-200" x-show="results.structured_data.totals.subtotal">
                            <span class="text-gray-600">Sous-total:</span>
                            <span class="font-medium" x-text="results.structured_data.totals.subtotal ? results.structured_data.totals.subtotal.toFixed(2) + ' €' : 'N/A'"></span>
                        </div>
                        
                        <!-- TVA -->
                        <template x-if="results.structured_data.totals.vat">
                            <template x-for="(vat, index) in Array.isArray(results.structured_data.totals.vat) ? results.structured_data.totals.vat : [results.structured_data.totals.vat]" :key="index">
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span class="text-gray-600" x-text="'TVA (' + vat.rate + '):'"></span>
                                    <span class="font-medium" x-text="vat.amount.toFixed(2) + ' €'"></span>
                                </div>
                            </template>
                        </template>
                        
                        <!-- TVA (si présente comme total direct) -->
                        <div class="flex justify-between py-2 border-b border-gray-200" x-show="results.structured_data.totals.vat_total">
                            <span class="text-gray-600">TVA totale:</span>
                            <span class="font-medium" x-text="results.structured_data.totals.vat_total.toFixed(2) + ' €'"></span>
                        </div>
                        
                        <!-- Total -->
                        <div class="flex justify-between py-2 font-semibold text-lg">
                            <span>Total:</span>
                            <span x-text="results.structured_data.totals.total ? results.structured_data.totals.total.toFixed(2) + ' ' + (results.structured_data.totals.currency || '€') : 'N/A'"></span>
                        </div>
                    </div>
                </div>
            </div>
			
			<!-- Données structurées de devis technique -->
			<div x-show="results.type_document === 'devis_technique'" class="space-y-6 mt-8 border-t pt-8">
				<h3 class="text-xl font-semibold mb-4 flex items-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
					</svg>
					Devis technique
				</h3>
				
				<!-- Info sur le score de confiance -->
				<div class="bg-green-50 p-4 rounded-lg mb-6" x-show="results.metadata">
					<div class="flex items-center">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
						</svg>
						<p class="text-sm text-green-800">
							<span>Confiance: <span class="font-semibold" x-text="results.metadata?.confidence ? (results.metadata.confidence * 100).toFixed(0) + '%' : 'N/A'"></span></span>
							<span class="ml-4">Méthode: <span class="font-semibold" x-text="results.extraction_method || 'standard'"></span></span>
						</p>
					</div>
				</div>
				
				<!-- Informations générales du devis -->
				<div class="bg-white rounded-lg border shadow-sm p-4 mb-6" x-show="results.metadata">
					<h4 class="font-semibold text-lg mb-3 text-gray-700">Informations du devis</h4>
					<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
						<div class="space-y-1">
							<p class="text-sm text-gray-500">Référence</p>
							<p class="font-medium" x-text="results.metadata.reference || 'N/A'"></p>
						</div>
						<div class="space-y-1">
							<p class="text-sm text-gray-500">Date</p>
							<p class="font-medium" x-text="results.metadata.date || 'N/A'"></p>
						</div>
						<div class="space-y-1">
							<p class="text-sm text-gray-500">Client</p>
							<p class="font-medium" x-text="results.metadata.client || 'N/A'"></p>
						</div>
						<div class="space-y-1">
							<p class="text-sm text-gray-500">Contact</p>
							<p class="font-medium" x-text="results.metadata.contact || 'N/A'"></p>
						</div>
					</div>
				</div>
				
				<!-- Sections du devis -->
				<div class="bg-white rounded-lg border shadow-sm p-4 mb-6" x-show="results.sections && results.sections.length > 0">
					<h4 class="font-semibold text-lg mb-3 text-gray-700">Sections techniques</h4>
					
					<template x-for="(section, sectionIndex) in results.sections" :key="sectionIndex">
						<div class="mb-6">
							<h5 class="font-medium flex items-center text-lg mb-2">
								<span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-2"></span>
								<span x-text="section.type ? section.type.charAt(0).toUpperCase() + section.type.slice(1) : 'Section'"></span>
								<span x-show="section.prix_ht" class="ml-auto text-base" x-text="section.prix_ht + ' €'"></span>
							</h5>
							
							<!-- Éléments de la section -->
							<div x-show="section.elements && section.elements.length > 0" class="bg-gray-50 rounded-lg p-4">
								<div class="overflow-x-auto">
									<table class="min-w-full divide-y divide-gray-200">
										<thead class="bg-gray-100">
											<tr>
												<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
												<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité</th>
												<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unité</th>
												<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dimensions</th>
												<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spécifications</th>
												<th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Prix unitaire</th>
											</tr>
										</thead>
										<tbody class="bg-white divide-y divide-gray-200">
											<template x-for="(element, elementIndex) in section.elements" :key="elementIndex">
												<tr class="hover:bg-gray-50">
													<td class="px-4 py-2 text-sm text-gray-700" x-text="element.description || 'N/A'"></td>
													<td class="px-4 py-2 text-sm text-gray-700" x-text="element.quantite || 'N/A'"></td>
													<td class="px-4 py-2 text-sm text-gray-700" x-text="element.unite || 'N/A'"></td>
													<td class="px-4 py-2 text-sm text-gray-700" x-text="element.dimensions || 'N/A'"></td>
													<td class="px-4 py-2 text-sm text-gray-700" x-text="element.specifications || 'N/A'"></td>
													<td class="px-4 py-2 text-sm text-gray-700 text-right" x-text="element.prix_unitaire ? element.prix_unitaire + ' €' : 'N/A'"></td>
												</tr>
											</template>
										</tbody>
									</table>
								</div>
							</div>
							<div x-show="!section.elements || section.elements.length === 0" class="bg-gray-50 rounded-lg p-4 text-center text-gray-500">
								Aucun élément trouvé dans cette section
							</div>
						</div>
					</template>
				</div>
				
				<!-- Totaux du devis -->
				<div class="bg-white rounded-lg border shadow-sm p-4" x-show="results.totals">
					<h4 class="font-semibold text-lg mb-3 text-gray-700">Totaux</h4>
					<div class="bg-gray-50 p-4 rounded-lg max-w-md ml-auto">
						<div class="flex justify-between py-2 border-b border-gray-200" x-show="results.totals.montant_ht !== null">
							<span class="text-gray-600">Montant HT:</span>
							<span class="font-medium" x-text="results.totals.montant_ht + ' ' + results.totals.currency"></span>
						</div>
						
						<!-- TVA -->
						<div class="flex justify-between py-2 border-b border-gray-200" x-show="results.totals.tva !== null">
							<span class="text-gray-600">TVA:</span>
							<span class="font-medium" x-text="results.totals.tva + ' ' + results.totals.currency"></span>
						</div>
						
						<!-- Total TTC -->
						<div class="flex justify-between py-2 font-semibold text-lg" x-show="results.totals.montant_ttc !== null">
							<span>Total TTC:</span>
							<span x-text="results.totals.montant_ttc + ' ' + results.totals.currency"></span>
						</div>
					</div>
				</div>
				
				<!-- Conditions -->
				<div class="bg-white rounded-lg border shadow-sm p-4" x-show="results.conditions">
					<h4 class="font-semibold text-lg mb-3 text-gray-700">Conditions</h4>
					<div class="space-y-3">
						<div class="flex" x-show="results.conditions.delai">
							<span class="font-medium w-32">Délai:</span>
							<span x-text="results.conditions.delai"></span>
						</div>
						<div class="flex" x-show="results.conditions.paiement">
							<span class="font-medium w-32">Paiement:</span>
							<span x-text="results.conditions.paiement"></span>
						</div>
						<div class="flex" x-show="results.conditions.validite">
							<span class="font-medium w-32">Validité:</span>
							<span x-text="results.conditions.validite"></span>
						</div>
					</div>
				</div>
			</div>
			
            <!-- Images des tableaux -->
            <div x-show="results.images && results.images.length > 0" class="mt-8 border-t pt-8">
                <h3 class="text-lg font-semibold mb-4">Images des tableaux</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <template x-for="(image, imageIndex) in results.images" :key="imageIndex">
                        <div class="border rounded-lg overflow-hidden">
                            <div class="bg-gray-50 p-2 border-b">
                                <h4 class="font-medium text-sm" x-text="`Tableau ${imageIndex + 1} - Page ${image.page || 'N/A'}`"></h4>
                            </div>
                            <div class="p-2">
                                <img :src="'data:image/png;base64,' + image.data" alt="Table image" class="max-w-full">
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="flex justify-end mt-6">
                <button @click="downloadResults" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Télécharger les résultats
                </button>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="text-xl font-bold">Gustave PDF</h3>
                    <p class="text-gray-400 text-sm mt-1">Outil d'extraction et d'analyse de tableaux PDF</p>
                </div>
                <div class="text-gray-400 text-sm">
                    <p>Développé avec FastAPI et Tailwind CSS</p>
                    <p class="mt-1">© 2025 - Gustave</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        function pdfApp() {
            return {
                // État de l'application
                selectedFile: null,
                fileSelected: false,
                dragOver: false,
                isLoading: false,
                isDetecting: false,
                results: null,
                error: null,
                isPdfTypeDetected: false,
                isPdfScanned: false,
                pdfTypeDetectionConfidence: 0,
                
                // Options de traitement
                strategy: 'auto',
                outputFormat: 'json',
                pages: 'all',
                documentType: 'generic',
                includeImages: false,
                
                // Options OCR
                ocrEnabled: false,
                ocrLanguage: 'fra+eng',
                ocrEnhanceImage: true,
                ocrDeskew: true,
                
                // Options avancées
                analyze: false,
                searchQuery: '',
                backgroundProcessing: false,
                extractCheckboxes: false,
                useCache: true,
                downloadFormat: '',
                
                // Configuration de l'API
                apiEndpoint: 'https://api.symple.fr/api/pdf/tables',
                apiKey: 'gustave_slCNYWzQG8eEQjytE7awzlScPsH3QbRj',
                
                // Méthodes
                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file && file.type === 'application/pdf') {
                        this.selectedFile = file;
                        this.fileSelected = true;
                        this.error = null;
                        this.isPdfTypeDetected = false;
                        this.isPdfScanned = false;
                    } else {
                        this.error = "Veuillez sélectionner un fichier PDF valide.";
                    }
                },
                
                handleFileDrop(event) {
                    this.dragOver = false;
                    const file = event.dataTransfer.files[0];
                    if (file && file.type === 'application/pdf') {
                        this.selectedFile = file;
                        this.fileSelected = true;
                        this.error = null;
                        this.isPdfTypeDetected = false;
                        this.isPdfScanned = false;
                    } else {
                        this.error = "Veuillez sélectionner un fichier PDF valide.";
                    }
                },
                
                resetFile() {
                    this.selectedFile = null;
                    this.fileSelected = false;
                    this.isPdfTypeDetected = false;
                    this.isPdfScanned = false;
                },
                
                resetForm() {
                    this.resetFile();
                    this.strategy = 'auto';
                    this.outputFormat = 'json';
                    this.pages = 'all';
                    this.documentType = 'generic';
                    this.includeImages = false;
                    this.ocrEnabled = false;
                    this.ocrLanguage = 'fra+eng';
                    this.ocrEnhanceImage = true;
                    this.ocrDeskew = true;
                    this.analyze = false;
                    this.searchQuery = '';
                    this.backgroundProcessing = false;
                    this.extractCheckboxes = false;
                    this.useCache = true;
                    this.downloadFormat = '';
                    this.results = null;
                    this.error = null;
                },
                
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                
                async submitForm() {
                    if (!this.fileSelected) return;
                    
                    this.error = null;
                    this.results = null;
                    this.isLoading = true;
                    
                    try {
                        const formData = new FormData();
                        formData.append('file', this.selectedFile);
                        
                        // Paramètres communs
                        formData.append('strategy', this.strategy);
                        formData.append('output_format', this.outputFormat);
                        formData.append('pages', this.pages);
                        formData.append('document_type', this.documentType);
                        formData.append('ocr_enabled', this.ocrEnabled);
                        formData.append('include_images', this.includeImages);
                        formData.append('analyze', this.analyze);
                        formData.append('background_processing', this.backgroundProcessing);
                        formData.append('use_cache', this.useCache);
                        formData.append('extract_checkboxes', this.extractCheckboxes);
                        
                        // Format de téléchargement si spécifié
                        if (this.downloadFormat) {
                            formData.append('download_format', this.downloadFormat);
                        }
                        
                        // Paramètres OCR
                        if (this.ocrEnabled) {
                            formData.append('ocr_language', this.ocrLanguage);
                            formData.append('ocr_enhance_image', this.ocrEnhanceImage);
                            formData.append('ocr_deskew', this.ocrDeskew);
                        }
                        
                        // Recherche si demandée
                        if (this.searchQuery.trim()) {
                            formData.append('search_query', this.searchQuery);
                        }
                        
                        const response = await fetch(`${this.apiEndpoint}/extract?api_key=${this.apiKey}`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'Une erreur s\'est produite');
                        }
                        
                        const result = await response.json();
                        
                        // Si c'est une tâche en arrière-plan
                        if (result.task_id && result.status === 'processing') {
                            await this.pollTaskStatus(result.task_id);
                        } else {
                            this.results = result;
                        }
                        
                        // Scroll to results
                        if (this.results) {
                            setTimeout(() => {
                                const resultsElement = document.querySelector('.bg-white.rounded-lg.shadow-md.p-6:last-child');
                                if (resultsElement) {
                                    resultsElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            }, 100);
                        }
                        
                    } catch (error) {
                        this.error = error.message || 'Une erreur s\'est produite lors du traitement';
                        console.error('Erreur:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async pollTaskStatus(taskId) {
                    // Fonction pour vérifier l'état d'une tâche en arrière-plan
                    const checkStatus = async () => {
                        try {
                            const response = await fetch(`${this.apiEndpoint}/tasks/${taskId}?api_key=${this.apiKey}`);
                            
                            if (!response.ok) {
                                throw new Error('Erreur lors de la récupération du statut de la tâche');
                            }
                            
                            const taskStatus = await response.json();
                            
                            if (taskStatus.status === 'completed') {
                                this.results = taskStatus.results;
                                return true;
                            } else if (taskStatus.status === 'error') {
                                throw new Error(taskStatus.message || 'Erreur lors du traitement');
                            }
                            
                            return false;
                        } catch (error) {
                            this.error = error.message;
                            return true; // Arrêter le polling en cas d'erreur
                        }
                    };
                    
                    // Vérifier toutes les 2 secondes jusqu'à ce que la tâche soit terminée
                    let isComplete = false;
                    while (!isComplete && this.isLoading) {
                        isComplete = await checkStatus();
                        if (!isComplete) {
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    }
                },
                
                downloadResults() {
                    if (!this.results) return;
                    
                    const dataStr = JSON.stringify(this.results, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileName = `${this.selectedFile.name.replace('.pdf', '')}_results.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileName);
                    linkElement.click();
                },
                
                downloadTableData(table, tableIndex) {
                    if (!table || !table.data) return;
                    
                    const baseFileName = `${this.selectedFile.name.replace('.pdf', '')}_table_${tableIndex + 1}`;
                    let dataStr, dataUri, mimeType, extension;
                    
                    switch(this.outputFormat) {
                        case 'json':
                            dataStr = JSON.stringify(table.data, null, 2);
                            mimeType = 'application/json;charset=utf-8';
                            extension = 'json';
                            break;
                            
                        case 'csv':
                            // Si les données sont déjà au format CSV
                            if (typeof table.data === 'string') {
                                dataStr = table.data;
                            } else {
                                // Conversion simple de JSON à CSV si nécessaire
                                dataStr = this.convertJsonToCsv(table.data);
                            }
                            mimeType = 'text/csv;charset=utf-8';
                            extension = 'csv';
                            break;
                            
                        case 'html':
                            dataStr = typeof table.data === 'string' ? table.data : 
                                '<table border="1" cellpadding="5" cellspacing="0">' + this.convertJsonToHtmlTable(table.data) + '</table>';
                            mimeType = 'text/html;charset=utf-8';
                            extension = 'html';
                            break;
                            
                        case 'excel':
                            // Pour Excel, nous utilisons CSV comme fallback
                            if (typeof table.data === 'string') {
                                dataStr = table.data;
                            } else {
                                dataStr = this.convertJsonToCsv(table.data);
                            }
                            mimeType = 'text/csv;charset=utf-8';
                            extension = 'csv';
                            break;
                            
                        default:
                            dataStr = JSON.stringify(table.data, null, 2);
                            mimeType = 'application/json;charset=utf-8';
                            extension = 'json';
                    }
                    
                    dataUri = `data:${mimeType},${encodeURIComponent(dataStr)}`;
                    const exportFileName = `${baseFileName}.${extension}`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileName);
                    linkElement.click();
                },
                
                convertJsonToCsv(jsonData) {
                    if (!jsonData || jsonData.length === 0) return '';
                    
                    // Déterminer les en-têtes (toutes les clés possibles à partir de tous les objets)
                    const headers = Array.isArray(jsonData) && jsonData.length > 0 ? 
                        Object.keys(jsonData[0]) : Object.keys(jsonData);
                    
                    // Créer la ligne d'en-tête CSV
                    let csvContent = headers.join(',') + '\r\n';
                    
                    // Ajouter les lignes de données
                    if (Array.isArray(jsonData)) {
                        jsonData.forEach(item => {
                            const row = headers.map(header => {
                                const value = item[header];
                                // Échapper les guillemets et entourer de guillemets si nécessaire
                                const formattedValue = value === null || value === undefined ? '' : 
                                    String(value).replace(/"/g, '""');
                                return `"${formattedValue}"`;
                            });
                            csvContent += row.join(',') + '\r\n';
                        });
                    } else {
                        // Si c'est un objet unique
                        const row = headers.map(header => {
                            const value = jsonData[header];
                            const formattedValue = value === null || value === undefined ? '' : 
                                String(value).replace(/"/g, '""');
                            return `"${formattedValue}"`;
                        });
                        csvContent += row.join(',') + '\r\n';
                    }
                    
                    return csvContent;
                },
                
                convertJsonToHtmlTable(jsonData) {
                    if (!jsonData || (Array.isArray(jsonData) && jsonData.length === 0)) return '';
                    
                    // Déterminer les en-têtes
                    const headers = Array.isArray(jsonData) && jsonData.length > 0 ? 
                        Object.keys(jsonData[0]) : Object.keys(jsonData);
                    
                    // Créer l'en-tête HTML
                    let htmlContent = '<thead><tr>';
                    headers.forEach(header => {
                        htmlContent += `<th>${header}</th>`;
                    });
                    htmlContent += '</tr></thead><tbody>';
                    
                    // Ajouter les lignes de données
                    if (Array.isArray(jsonData)) {
                        jsonData.forEach(item => {
                            htmlContent += '<tr>';
                            headers.forEach(header => {
                                const value = item[header] !== null && item[header] !== undefined ? item[header] : '';
                                htmlContent += `<td>${value}</td>`;
                            });
                            htmlContent += '</tr>';
                        });
                    } else {
                        // Si c'est un objet unique
                        htmlContent += '<tr>';
                        headers.forEach(header => {
                            const value = jsonData[header] !== null && jsonData[header] !== undefined ? jsonData[header] : '';
                            htmlContent += `<td>${value}</td>`;
                        });
                        htmlContent += '</tr>';
                    }
                    
                    htmlContent += '</tbody>';
                    return htmlContent;
                }
            }
        }
    </script>
</body>
</html>