<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gustave - API PDF</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.10.3/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen" x-data="pdfApp()">
    <header class="bg-indigo-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-3xl font-bold">Gustave PDF</h1>
            <p class="text-indigo-200">Extraction et analyse de tableaux PDF</p>
        </div>
    </header>

    <main class="container mx-auto p-4 my-8">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                <h2 class="text-2xl font-semibold">Sélectionnez votre fichier PDF</h2>
            </div>

            <form @submit.prevent="submitForm" class="space-y-4">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center" 
                     @dragover.prevent="dragOver = true" 
                     @dragleave.prevent="dragOver = false" 
                     @drop.prevent="handleFileDrop($event)"
                     :class="{'bg-indigo-50 border-indigo-300': dragOver}">
                    <div x-show="!fileSelected">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p class="text-gray-700 mb-2">Glissez-déposez votre fichier PDF ici</p>
                        <p class="text-gray-500 text-sm mb-4">ou</p>
                        <label class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 cursor-pointer">
                            Parcourir...
                            <input type="file" accept=".pdf" class="hidden" @change="handleFileSelect($event)">
                        </label>
                    </div>
                    <div x-show="fileSelected" class="flex items-center justify-center space-x-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <div class="flex-1 truncate">
                            <p class="font-medium text-gray-900 truncate" x-text="selectedFile.name"></p>
                            <p class="text-sm text-gray-500" x-text="formatFileSize(selectedFile.size)"></p>
                        </div>
                        <button type="button" @click="resetFile" class="text-gray-500 hover:text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Bouton pour détecter automatiquement si le PDF est scanné -->
                <div x-show="fileSelected && !isPdfTypeDetected" class="flex justify-center">
                    <button type="button" @click="detectPdfType" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                        <svg x-show="isDetecting" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-show="!isDetecting">Analyser le type de PDF</span>
                        <span x-show="isDetecting">Analyse en cours...</span>
                    </button>
                </div>

                <!-- Affichage des résultats de la détection du type de PDF -->
                <div x-show="isPdfTypeDetected" class="p-4 rounded-lg" :class="isPdfScanned ? 'bg-yellow-50 border border-yellow-300' : 'bg-green-50 border border-green-300'">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg x-show="!isPdfScanned" class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            <svg x-show="isPdfScanned" class="h-5 w-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p x-show="!isPdfScanned" class="text-sm text-green-700">PDF avec texte sélectionnable détecté. L'extraction standard est recommandée.</p>
                            <p x-show="isPdfScanned" class="text-sm text-yellow-700">PDF scanné détecté. L'extraction OCR est recommandée et activée automatiquement.</p>
                            <p class="text-xs text-gray-500 mt-1" x-text="'Confiance de la détection: ' + (pdfTypeDetectionConfidence * 100).toFixed(0) + '%'"></p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
					<div>
						<label class="block text-gray-700 font-medium mb-2">Action à effectuer</label>
						<select x-model="selectedAction" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
							<option value="extract-tables">Extraire les tableaux</option>
							<option value="extract-tables-ocr">Extraire les tableaux (OCR)</option>
							<option value="analyze-table">Analyser un tableau</option>
							<option value="convert-table">Convertir un tableau</option>
							<option value="search-tables">Rechercher dans les tableaux</option>
							<option value="export-all-tables">Exporter tous les tableaux</option>
						</select>
					</div>

					<div>
						<label class="block text-gray-700 font-medium mb-2">Pages</label>
						<input type="text" x-model="pages" placeholder="all, 1, 1-3, 1,3,5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
					</div>
				</div>
				
				<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
					<div>
						<label class="block text-gray-700 font-medium mb-2">Type de document</label>
						<select x-model="documentType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
							<option value="generic">Générique</option>
							<option value="invoice">Facture</option>
							<option value="receipt">Reçu</option>
						</select>
					</div>
					
					<div x-show="documentType === 'invoice'" class="bg-blue-50 p-3 rounded border border-blue-200">
						<div class="flex">
							<div class="flex-shrink-0">
								<svg class="h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
									<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
								</svg>
							</div>
							<div class="ml-3">
								<p class="text-sm text-blue-700">Le mode facture applique un post-traitement spécifique pour extraire informations, lignes et totaux.</p>
							</div>
						</div>
					</div>
				</div>

                <!-- Options spécifiques à l'extraction de tableaux standard -->
                <div x-show="selectedAction === 'extract-tables'" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Méthode d'extraction</label>
                        <select x-model="extractionMethod" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="auto">Auto</option>
                            <option value="tabula">Tabula</option>
                            <option value="camelot">Camelot</option>
                            <option value="pdfplumber">PDFPlumber</option>
                            <option value="ocr">OCR (PDF scanné)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Format de sortie</label>
                        <select x-model="outputFormat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="html">HTML</option>
                            <option value="excel">Excel</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="flex items-center">
                            <input type="checkbox" x-model="includeImages" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Inclure les images des tableaux</span>
                        </label>
                    </div>

                    <!-- Option OCR pour tous les modes d'extraction -->
                    <div class="md:col-span-2">
                        <label class="flex items-center">
                            <input type="checkbox" x-model="ocrEnabled" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Activer l'OCR pour les PDF scannés</span>
                        </label>
                    </div>
                </div>

                <!-- Options spécifiques à l'extraction OCR -->
                <div x-show="selectedAction === 'extract-tables-ocr' || (selectedAction === 'extract-tables' && (ocrEnabled || extractionMethod === 'ocr'))" class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <div class="md:col-span-2">
                        <h3 class="font-medium text-yellow-800 mb-2">Options OCR pour PDF scannés</h3>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Langues OCR</label>
                        <select x-model="ocrLanguage" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="fra">Français</option>
                            <option value="eng">Anglais</option>
                            <option value="fra+eng">Français + Anglais</option>
                            <option value="deu">Allemand</option>
                            <option value="spa">Espagnol</option>
                            <option value="ita">Italien</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Format de sortie</label>
                        <select x-model="outputFormat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="html">HTML</option>
                            <option value="excel">Excel</option>
                        </select>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="ocrEnhanceImage" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Améliorer l'image (contraste)</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="ocrDeskew" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Corriger l'inclinaison</span>
                        </label>
                    </div>
                </div>

                <!-- Options spécifiques à l'analyse de tableau -->
                <div x-show="selectedAction === 'analyze-table'" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Numéro de page</label>
                        <input type="number" x-model="pageNumber" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Index du tableau</label>
                        <input type="number" x-model="tableIndex" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <!-- Option OCR pour l'analyse de tableau -->
                    <div class="md:col-span-2">
                        <label class="flex items-center">
                            <input type="checkbox" x-model="ocrEnabled" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Activer l'OCR pour les PDF scannés</span>
                        </label>
                    </div>
                </div>

                <!-- Options spécifiques à la conversion de tableau -->
                <div x-show="selectedAction === 'convert-table'" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Numéro de page</label>
                        <input type="number" x-model="pageNumber" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Index du tableau</label>
                        <input type="number" x-model="tableIndex" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Format de sortie</label>
                        <select x-model="outputFormat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="html">HTML</option>
                            <option value="excel">Excel</option>
                        </select>
                    </div>
                    <!-- Option OCR pour la conversion de tableau -->
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="ocrEnabled" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Activer l'OCR pour les PDF scannés</span>
                        </label>
                    </div>
                </div>

                <!-- Options spécifiques à la recherche dans les tableaux -->
                <div x-show="selectedAction === 'search-tables'" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-medium mb-2">Texte à rechercher</label>
                        <input type="text" x-model="searchQuery" placeholder="Entrez votre recherche..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="caseSensitive" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Sensible à la casse</span>
                        </label>
                    </div>
                    <!-- Option OCR pour la recherche dans les tableaux -->
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="ocrEnabled" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Activer l'OCR pour les PDF scannés</span>
                        </label>
                    </div>
                </div>

                <!-- Options spécifiques à l'export de tous les tableaux -->
                <div x-show="selectedAction === 'export-all-tables'" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Format de sortie</label>
                        <select x-model="outputFormat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="excel">Excel (un fichier avec plusieurs feuilles)</option>
                            <option value="csv">CSV (archive zip)</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>
                    <!-- Option OCR pour l'export de tous les tableaux -->
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="ocrEnabled" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-gray-700">Activer l'OCR pour les PDF scannés</span>
                        </label>
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" @click="resetForm" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Réinitialiser
                    </button>
                    <button type="submit" :disabled="isLoading || !fileSelected" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                        <svg x-show="isLoading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-show="!isLoading">Exécuter</span>
                        <span x-show="isLoading">Traitement en cours...</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Résultats -->
        <div x-show="results !== null" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Résultats
            </h2>

            <!-- Indication si OCR a été utilisé -->
            <div x-show="results.ocr_used" class="mb-4 p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">L'OCR a été utilisé pour l'extraction des tableaux de ce PDF scanné.</p>
                    </div>
                </div>
            </div>

            <!-- Extrait des infos de base -->
            <div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Fichier</p>
                    <p class="font-medium text-gray-900" x-text="results.filename || 'N/A'"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Taille</p>
                    <p class="font-medium text-gray-900" x-text="results.file_size ? formatFileSize(results.file_size) : 'N/A'"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Temps de traitement</p>
                    <p class="font-medium text-gray-900" x-text="results.processing_time ? `${results.processing_time.toFixed(2)}s` : 'N/A'"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Tableaux trouvés</p>
                    <p class="font-medium text-gray-900" x-text="results.tables_count || results.tables?.length || 'N/A'"></p>
                </div>
            </div>

            <!-- Méthode d'extraction utilisée -->
            <div x-show="results.extraction_method_used" class="mb-4 flex items-center p-3 bg-gray-50 rounded-lg">
                <div class="mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-700">
                        Méthode d'extraction utilisée :
                        <span class="font-semibold" x-text="results.extraction_method_used"></span>
                    </p>
                </div>
            </div>

            <!-- Tableaux de résultats -->
            <div x-show="(selectedAction === 'extract-tables' || selectedAction === 'extract-tables-ocr') && results.tables" class="overflow-x-auto">
                <div class="p-4 border rounded-lg mb-4 bg-indigo-50" x-show="results.tables.length === 0">
                    Aucun tableau n'a été trouvé dans le document.
                </div>
                
                <template x-for="(table, tableIndex) in results.tables" :key="tableIndex">
                    <div class="mb-6 border rounded-lg overflow-hidden">
                        <div class="flex justify-between items-center p-4 bg-gray-50 border-b">
                            <h3 class="font-semibold" x-text="`Tableau ${tableIndex + 1}`"></h3>
                            <div class="flex items-center">
                                <span class="text-sm text-gray-600" x-text="`Page: ${table.page || 'N/A'}`"></span>
                                <span class="ml-4 text-sm text-gray-600" x-text="`Lignes: ${table.rows || 'N/A'}`"></span>
                                <span class="ml-4 text-sm text-gray-600" x-text="`Colonnes: ${table.columns || 'N/A'}`"></span>
                                <button @click="downloadTableData(table, tableIndex)" class="ml-4 px-3 py-1 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Télécharger
                                </button>
                            </div>
                        </div>
                        <div class="p-4 overflow-x-auto">
                            <!-- Affichage pour le format HTML -->
                            <div x-show="outputFormat === 'html'" x-html="table.data"></div>
                            
                            <!-- Affichage pour JSON et autres formats -->
                            <pre x-show="outputFormat !== 'html'" class="text-sm whitespace-pre-wrap bg-gray-50 p-4 rounded" x-text="JSON.stringify(table.data, null, 2)"></pre>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Analyse de tableau -->
            <div x-show="selectedAction === 'analyze-table' && results.analysis" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-500">Lignes</p>
                        <p class="font-medium text-gray-900" x-text="results.analysis.row_count"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-500">Colonnes</p>
                        <p class="font-medium text-gray-900" x-text="results.analysis.column_count"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-500">Cellules vides</p>
                        <p class="font-medium text-gray-900" x-text="`${results.analysis.empty_cells} (${results.analysis.empty_cells_percent}%)`"></p>
                    </div>
                </div>

                <h3 class="text-lg font-semibold mb-2">Aperçu du tableau</h3>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <template x-for="(col, colIndex) in Object.keys(results.preview[0] || {})" :key="colIndex">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-text="col"></th>
                                </template>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="(row, rowIndex) in results.preview" :key="rowIndex">
                                <tr class="hover:bg-gray-50">
                                    <template x-for="(col, colIndex) in Object.keys(results.preview[0] || {})" :key="colIndex">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="row[col]"></td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-lg font-semibold mb-2">Analyse des colonnes</h3>
                <div class="space-y-4">
                    <template x-for="(col, colIndex) in results.analysis.columns" :key="colIndex">
                        <div class="border rounded-lg overflow-hidden">
                            <div class="bg-gray-50 p-4 border-b">
                                <h4 class="font-medium" x-text="col.name"></h4>
                                <div class="flex space-x-4 text-sm text-gray-500 mt-1">
                                    <span x-text="`Type: ${col.data_type}`"></span>
                                    <span x-text="`Non-null: ${col.non_null_count}/${results.analysis.row_count}`"></span>
                                </div>
                            </div>
                            <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Statistiques numériques -->
                                <div x-show="col.data_type === 'numeric'" class="space-y-2">
                                    <p><span class="font-medium">Min:</span> <span x-text="col.min !== null ? col.min : 'N/A'"></span></p>
                                    <p><span class="font-medium">Max:</span> <span x-text="col.max !== null ? col.max : 'N/A'"></span></p>
                                    <p><span class="font-medium">Moyenne:</span> <span x-text="col.mean !== null ? col.mean : 'N/A'"></span></p>
                                    <p><span class="font-medium">Médiane:</span> <span x-text="col.median !== null ? col.median : 'N/A'"></span></p>
                                </div>
                                
                                <!-- Statistiques temporelles -->
                                <div x-show="col.data_type === 'datetime'" class="space-y-2">
                                    <p><span class="font-medium">Date min:</span> <span x-text="col.min || 'N/A'"></span></p>
                                    <p><span class="font-medium">Date max:</span> <span x-text="col.max || 'N/A'"></span></p>
                                </div>
                                
                                <!-- Statistiques textuelles -->
                                <div x-show="col.data_type === 'text'" class="space-y-2">
                                    <p><span class="font-medium">Valeurs uniques:</span> <span x-text="col.unique_values"></span></p>
                                    <p><span class="font-medium">Longueur moyenne:</span> <span x-text="col.avg_length"></span></p>
                                    <div x-show="Object.keys(col.most_common || {}).length > 0">
                                        <p class="font-medium">Valeurs les plus fréquentes:</p>
                                        <ul class="list-disc list-inside">
                                            <template x-for="(count, value) in col.most_common" :key="value">
                                                <li x-text="`${value}: ${count} occurrences`"></li>
                                            </template>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Recherche dans les tableaux -->
            <div x-show="selectedAction === 'search-tables'" class="space-y-6">
                <div class="p-4 bg-indigo-50 rounded-lg mb-4">
                    <p class="font-medium">Recherche de: <span class="font-bold" x-text="results.query"></span></p>
                    <p class="text-sm mt-1">
                        <span x-text="`${results.matching_tables} tableaux correspondants sur ${results.tables_scanned}`"></span>
                        <span class="ml-4" x-text="`${results.total_matches} correspondances trouvées`"></span>
                    </p>
                </div>

                <div x-show="results.results.length === 0" class="p-4 border rounded-lg">
                    Aucune correspondance trouvée.
                </div>

                <template x-for="(tableResult, resultIndex) in results.results" :key="resultIndex">
                    <div class="border rounded-lg overflow-hidden mb-4">
                        <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                            <h3 class="font-medium" x-text="`Tableau ${tableResult.table_id}`"></h3>
                            <span class="text-sm text-gray-600" x-text="`Page ${tableResult.page} · ${tableResult.matches_count} correspondances`"></span>
                        </div>
                        <div class="p-4">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ligne</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Colonne</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valeur</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="(match, matchIndex) in tableResult.matches" :key="matchIndex">
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="match.row + 1"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="match.column"></td>
                                                <td class="px-6 py-4 text-sm text-gray-800" x-text="match.value"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
			
			<!-- Données structurées de facture -->
			<div x-show="results.structured_data" class="space-y-6 mt-8 border-t pt-8">
				<h3 class="text-xl font-semibold mb-4 flex items-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
					</svg>
					Données structurées de facture
				</h3>
				
				<!-- Info sur le score de confiance -->
				<div class="bg-blue-50 p-4 rounded-lg mb-6">
					<div class="flex items-center">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
						</svg>
						<p class="text-sm text-blue-800">
							<span>Type détecté: <span class="font-semibold" x-text="results.structured_data.metadata?.document_subtype || 'générique'"></span></span>
							<span class="ml-4">Confiance: <span class="font-semibold" x-text="results.structured_data.metadata?.confidence ? (results.structured_data.metadata.confidence * 100).toFixed(0) + '%' : 'N/A'"></span></span>
						</p>
					</div>
				</div>
				
				<!-- Informations générales de facture -->
				<div class="bg-white rounded-lg border shadow-sm p-4 mb-6" x-show="results.structured_data.invoice_info">
					<h4 class="font-semibold text-lg mb-3 text-gray-700">Informations de facture</h4>
					<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
						<div class="space-y-1">
							<p class="text-sm text-gray-500">Numéro de facture</p>
							<p class="font-medium" x-text="results.structured_data.invoice_info.number || 'N/A'"></p>
						</div>
						<div class="space-y-1">
							<p class="text-sm text-gray-500">Date</p>
							<p class="font-medium" x-text="results.structured_data.invoice_info.date || 'N/A'"></p>
						</div>
						<div class="space-y-1">
							<p class="text-sm text-gray-500">Fournisseur</p>
							<p class="font-medium" x-text="results.structured_data.invoice_info.vendor || 'N/A'"></p>
						</div>
						<div class="space-y-1">
							<p class="text-sm text-gray-500">Numéro TVA</p>
							<p class="font-medium" x-text="results.structured_data.invoice_info.vat_number || 'N/A'"></p>
						</div>
						<!-- Affichage de l'adresse si disponible -->
						<div class="col-span-2 space-y-1" x-show="results.structured_data.invoice_info.address">
							<p class="text-sm text-gray-500">Adresse</p>
							<p class="font-medium">
								<template x-for="(line, index) in results.structured_data.invoice_info.address" :key="index">
									<span>
										<span x-text="line"></span><br x-show="index < results.structured_data.invoice_info.address.length - 1">
									</span>
								</template>
							</p>
						</div>
					</div>
				</div>
				
				<!-- Lignes de facture -->
				<div class="bg-white rounded-lg border shadow-sm p-4 mb-6" x-show="results.structured_data.line_items && results.structured_data.line_items.length > 0">
					<h4 class="font-semibold text-lg mb-3 text-gray-700">Lignes de facturation</h4>
					<div class="overflow-x-auto">
						<table class="min-w-full divide-y divide-gray-200">
							<thead class="bg-gray-50">
								<tr>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
									<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
								</tr>
							</thead>
							<tbody class="bg-white divide-y divide-gray-200">
								<template x-for="(item, index) in results.structured_data.line_items" :key="index">
									<tr>
										<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.date || '-'"></td>
										<td class="px-6 py-4 text-sm text-gray-700">
											<span x-show="item.route" x-text="item.route"></span>
											<span x-show="item.route && item.passenger" class="text-gray-500 ml-2" x-text="'(' + item.passenger + ')'"></span>
											<span x-show="!item.route" x-text="item.description || 'Réduction'"></span>
										</td>
										<td class="px-6 py-4 whitespace-nowrap text-sm">
											<span x-show="item.type === 'flight'" class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Vol</span>
											<span x-show="item.type === 'discount'" class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Réduction</span>
											<span x-show="item.type !== 'flight' && item.type !== 'discount'" class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800" x-text="item.type"></span>
										</td>
										<td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium" :class="{'text-green-600': item.type === 'discount', 'text-gray-900': item.type !== 'discount'}" x-text="(item.amount < 0 ? '' : '') + item.amount.toFixed(2) + ' €'"></td>
									</tr>
								</template>
							</tbody>
						</table>
					</div>
				</div>
				
				<!-- Totaux de facture -->
				<div class="bg-white rounded-lg border shadow-sm p-4" x-show="results.structured_data.totals">
					<h4 class="font-semibold text-lg mb-3 text-gray-700">Totaux</h4>
					<div class="bg-gray-50 p-4 rounded-lg max-w-md ml-auto">
						<div class="flex justify-between py-2 border-b border-gray-200">
							<span class="text-gray-600">Sous-total:</span>
							<span class="font-medium" x-text="results.structured_data.totals.subtotal ? results.structured_data.totals.subtotal.toFixed(2) + ' €' : 'N/A'"></span>
						</div>
						
						<!-- TVA -->
						<template x-if="results.structured_data.totals.vat">
							<template x-for="(vat, index) in Array.isArray(results.structured_data.totals.vat) ? results.structured_data.totals.vat : [results.structured_data.totals.vat]" :key="index">
								<div class="flex justify-between py-2 border-b border-gray-200">
									<span class="text-gray-600" x-text="'TVA (' + vat.rate + '):'"></span>
									<span class="font-medium" x-text="vat.amount.toFixed(2) + ' €'"></span>
								</div>
							</template>
						</template>
						
						<!-- TVA (si présente comme total direct) -->
						<div class="flex justify-between py-2 border-b border-gray-200" x-show="results.structured_data.totals.vat_total">
							<span class="text-gray-600">TVA totale:</span>
							<span class="font-medium" x-text="results.structured_data.totals.vat_total.toFixed(2) + ' €'"></span>
						</div>
						
						<!-- Total -->
						<div class="flex justify-between py-2 font-semibold text-lg">
							<span>Total:</span>
							<span x-text="results.structured_data.totals.total ? results.structured_data.totals.total.toFixed(2) + ' ' + (results.structured_data.totals.currency || '€') : 'N/A'"></span>
						</div>
					</div>
				</div>
			</div>


            <!-- Images des tableaux -->
            <div x-show="(selectedAction === 'extract-tables' || selectedAction === 'extract-tables-ocr') && results.images && results.images.length > 0" class="mt-8">
                <h3 class="text-lg font-semibold mb-4">Images des tableaux</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <template x-for="(image, imageIndex) in results.images" :key="imageIndex">
                        <div class="border rounded-lg overflow-hidden">
                            <div class="bg-gray-50 p-2 border-b">
                                <h4 class="font-medium text-sm" x-text="`Tableau ${imageIndex + 1} - Page ${image.page || 'N/A'}`"></h4>
                            </div>
                            <div class="p-2">
                                <img :src="'data:image/png;base64,' + image.data" alt="Table image" class="max-w-full">
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="flex justify-end mt-6">
                <button @click="downloadResults" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Télécharger les résultats
                </button>
            </div>
        </div>

        <!-- Message d'erreur -->
        <div x-show="error" class="bg-red-50 border-l-4 border-red-500 p-4 mb-8">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700" x-text="error"></p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="text-xl font-bold">Gustave PDF</h3>
                    <p class="text-gray-400 text-sm mt-1">Outil d'extraction et d'analyse de tableaux PDF</p>
                </div>
                <div class="text-gray-400 text-sm">
                    <p>Développé avec FastAPI et Tailwind CSS</p>
                    <p class="mt-1">© 2025 - Gustave</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        function pdfApp() {
            return {
                // État de l'application
                selectedFile: null,
                fileSelected: false,
                dragOver: false,
                isLoading: false,
                isDetecting: false,
                results: null,
                error: null,
                isPdfTypeDetected: false,
                isPdfScanned: false,
                pdfTypeDetectionConfidence: 0,
                
                // Options de traitement
                selectedAction: 'extract-tables',
                pages: 'all',
                extractionMethod: 'auto',
                outputFormat: 'json',
                includeImages: false,
                pageNumber: 1,
                tableIndex: 0,
                searchQuery: '',
                caseSensitive: false,

                // Options OCR
                ocrEnabled: false,
                ocrLanguage: 'fra+eng',
                ocrEnhanceImage: true,
                ocrDeskew: true,
				documentType: 'generic',
                
                // Configuration de l'API
                apiEndpoint: 'https://api.symple.fr/api/pdf',
				apiKey: 'gustave_slCNYWzQG8eEQjytE7awzlScPsH3QbRj',
                
                // Méthodes
                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file && file.type === 'application/pdf') {
                        this.selectedFile = file;
                        this.fileSelected = true;
                        this.error = null;
                        // Réinitialiser la détection du type de PDF
                        this.isPdfTypeDetected = false;
                        this.isPdfScanned = false;
                    } else {
                        this.error = "Veuillez sélectionner un fichier PDF valide.";
                    }
                },
                
                handleFileDrop(event) {
                    this.dragOver = false;
                    const file = event.dataTransfer.files[0];
                    if (file && file.type === 'application/pdf') {
                        this.selectedFile = file;
                        this.fileSelected = true;
                        this.error = null;
                        // Réinitialiser la détection du type de PDF
                        this.isPdfTypeDetected = false;
                        this.isPdfScanned = false;
                    } else {
                        this.error = "Veuillez sélectionner un fichier PDF valide.";
                    }
                },
                
                resetFile() {
                    this.selectedFile = null;
                    this.fileSelected = false;
                    this.isPdfTypeDetected = false;
                    this.isPdfScanned = false;
                },
                
                resetForm() {
                    this.resetFile();
                    this.selectedAction = 'extract-tables';
                    this.pages = 'all';
                    this.extractionMethod = 'auto';
                    this.outputFormat = 'json';
                    this.includeImages = false;
                    this.pageNumber = 1;
                    this.tableIndex = 0;
                    this.searchQuery = '';
                    this.caseSensitive = false;
                    this.ocrEnabled = false;
                    this.ocrLanguage = 'fra+eng';
                    this.ocrEnhanceImage = true;
                    this.ocrDeskew = true;
					this.documentType = 'generic';
                    this.results = null;
                    this.error = null;
                    this.isPdfTypeDetected = false;
                    this.isPdfScanned = false;
                },
                
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                
                getEndpoint() {
                    const endpoints = {
                        'extract-tables': `${this.apiEndpoint}/extract-tables`,
                        'extract-tables-ocr': `${this.apiEndpoint}/extract-tables-ocr`,
                        'analyze-table': `${this.apiEndpoint}/analyze-table`,
                        'convert-table': `${this.apiEndpoint}/convert-table`,
                        'search-tables': `${this.apiEndpoint}/search-tables`,
                        'export-all-tables': `${this.apiEndpoint}/export-all-tables`
                    };
					const endpoint = baseEndpoints[this.selectedAction];
					return `${endpoint}?api_key=${this.apiKey}`;
                },
                
                async detectPdfType() {
                    if (!this.fileSelected) return;
                    
                    this.error = null;
                    this.isDetecting = true;
                    
                    try {
                        const formData = new FormData();
                        formData.append('file', this.selectedFile);
                        
                        const response = await fetch(`${this.apiEndpoint}/detect-pdf-type?api_key=${this.apiKey}`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'Une erreur s\'est produite');
                        }
                        
                        const result = await response.json();
                        this.isPdfScanned = result.is_scanned;
                        this.pdfTypeDetectionConfidence = result.confidence;
                        this.isPdfTypeDetected = true;
                        
                        // Activer automatiquement l'OCR si PDF scanné
                        if (this.isPdfScanned) {
                            this.ocrEnabled = true;
                            if (this.selectedAction === 'extract-tables') {
                                this.extractionMethod = 'ocr';
                            }
                        }
                        
                    } catch (error) {
                        this.error = error.message || 'Une erreur s\'est produite lors de la détection du type de PDF';
                        console.error('Erreur:', error);
                    } finally {
                        this.isDetecting = false;
                    }
                },
                
                async submitForm() {
                    if (!this.fileSelected) return;
                    
                    this.error = null;
                    this.results = null;
                    this.isLoading = true;
                    
                    try {
                        const formData = new FormData();
                        formData.append('file', this.selectedFile);
                        
                        // Ajout des paramètres selon l'action
                        switch(this.selectedAction) {
                            case 'extract-tables':
                                formData.append('pages', this.pages);
                                formData.append('extraction_method', this.extractionMethod);
                                formData.append('output_format', this.outputFormat);
                                formData.append('include_images', this.includeImages);
                                formData.append('ocr_enabled', this.ocrEnabled);
								formData.append('document_type', this.documentType);
                                
                                // Paramètres OCR si activé
                                if (this.ocrEnabled || this.extractionMethod === 'ocr') {
                                    formData.append('ocr_language', this.ocrLanguage);
                                    formData.append('ocr_enhance_image', this.ocrEnhanceImage);
                                    formData.append('ocr_deskew', this.ocrDeskew);
                                }
                                break;
                                
                            case 'extract-tables-ocr':
                                formData.append('pages', this.pages);
                                formData.append('languages', this.ocrLanguage);
                                formData.append('enhance_image', this.ocrEnhanceImage);
                                formData.append('deskew', this.ocrDeskew);
                                formData.append('output_format', this.outputFormat);
                                break;
                                
                            case 'analyze-table':
                                formData.append('page', this.pageNumber);
                                formData.append('table_index', this.tableIndex);
                                formData.append('ocr_enabled', this.ocrEnabled);
                                break;
                                
                            case 'convert-table':
                                formData.append('page', this.pageNumber);
                                formData.append('table_index', this.tableIndex);
                                formData.append('output_format', this.outputFormat);
                                formData.append('ocr_enabled', this.ocrEnabled);
                                break;
                                
                            case 'search-tables':
                                formData.append('query', this.searchQuery);
                                formData.append('pages', this.pages);
                                formData.append('case_sensitive', this.caseSensitive);
                                formData.append('ocr_enabled', this.ocrEnabled);
                                break;
                                
                            case 'export-all-tables':
                                formData.append('pages', this.pages);
                                formData.append('output_format', this.outputFormat);
                                formData.append('ocr_enabled', this.ocrEnabled);
                                break;
                        }
                        
                        const response = await fetch(this.getEndpoint(), {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'Une erreur s\'est produite');
                        }
                        
                        // Traitement spécial pour les téléchargements directs (export-all-tables)
                        if (this.selectedAction === 'export-all-tables' && this.outputFormat !== 'json') {
                            const blob = await response.blob();
                            const fileName = this.selectedFile.name.replace('.pdf', '') + '_tables.' + 
                                (this.outputFormat === 'excel' ? 'xlsx' : (this.outputFormat === 'csv' ? 'zip' : this.outputFormat));
                            
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = fileName;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            
                            this.results = {
                                filename: this.selectedFile.name,
                                file_size: this.selectedFile.size,
                                processing_time: 0,
                                tables_count: 0,
                                message: `Tableaux exportés avec succès au format ${this.outputFormat}`,
                                ocr_used: this.ocrEnabled
                            };
                        } else {
                            this.results = await response.json();
                        }
                        
                        // Scroll to results
                        setTimeout(() => {
                            document.querySelector('.bg-white.rounded-lg.shadow-md.p-6:last-child').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                        
                    } catch (error) {
                        this.error = error.message || 'Une erreur s\'est produite lors du traitement';
                        console.error('Erreur:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                downloadResults() {
                    if (!this.results) return;
                    
                    const dataStr = JSON.stringify(this.results, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileName = `${this.selectedFile.name.replace('.pdf', '')}_${this.selectedAction}_results.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileName);
                    linkElement.click();
                },
                
                downloadTableData(table, tableIndex) {
                    if (!table || !table.data) return;
                    
                    const baseFileName = `${this.selectedFile.name.replace('.pdf', '')}_table_${tableIndex + 1}`;
                    let dataStr, dataUri, mimeType, extension;
                    
                    switch(this.outputFormat) {
                        case 'json':
                            dataStr = JSON.stringify(table.data, null, 2);
                            mimeType = 'application/json;charset=utf-8';
                            extension = 'json';
                            break;
                            
                        case 'csv':
                            // Si les données sont déjà au format CSV
                            if (typeof table.data === 'string') {
                                dataStr = table.data;
                            } else {
                                // Conversion simple de JSON à CSV si nécessaire
                                dataStr = this.convertJsonToCsv(table.data);
                            }
                            mimeType = 'text/csv;charset=utf-8';
                            extension = 'csv';
                            break;
                            
                        case 'html':
                            dataStr = typeof table.data === 'string' ? table.data : 
                                '<table border="1" cellpadding="5" cellspacing="0">' + this.convertJsonToHtmlTable(table.data) + '</table>';
                            mimeType = 'text/html;charset=utf-8';
                            extension = 'html';
                            break;
                            
                        case 'excel':
                            // Pour Excel, nous utilisons CSV comme fallback
                            if (typeof table.data === 'string') {
                                dataStr = table.data;
                            } else {
                                dataStr = this.convertJsonToCsv(table.data);
                            }
                            mimeType = 'text/csv;charset=utf-8';
                            extension = 'csv';
                            break;
                            
                        default:
                            dataStr = JSON.stringify(table.data, null, 2);
                            mimeType = 'application/json;charset=utf-8';
                            extension = 'json';
                    }
                    
                    dataUri = `data:${mimeType},${encodeURIComponent(dataStr)}`;
                    const exportFileName = `${baseFileName}.${extension}`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileName);
                    linkElement.click();
                },
                
                convertJsonToCsv(jsonData) {
                    if (!jsonData || jsonData.length === 0) return '';
                    
                    // Déterminer les en-têtes (toutes les clés possibles à partir de tous les objets)
                    const headers = Array.isArray(jsonData) && jsonData.length > 0 ? 
                        Object.keys(jsonData[0]) : Object.keys(jsonData);
                    
                    // Créer la ligne d'en-tête CSV
                    let csvContent = headers.join(',') + '\r\n';
                    
                    // Ajouter les lignes de données
                    if (Array.isArray(jsonData)) {
                        jsonData.forEach(item => {
                            const row = headers.map(header => {
                                const value = item[header];
                                // Échapper les guillemets et entourer de guillemets si nécessaire
                                const formattedValue = value === null || value === undefined ? '' : 
                                    String(value).replace(/"/g, '""');
                                return `"${formattedValue}"`;
                            });
                            csvContent += row.join(',') + '\r\n';
                        });
                    } else {
                        // Si c'est un objet unique
                        const row = headers.map(header => {
                            const value = jsonData[header];
                            const formattedValue = value === null || value === undefined ? '' : 
                                String(value).replace(/"/g, '""');
                            return `"${formattedValue}"`;
                        });
                        csvContent += row.join(',') + '\r\n';
                    }
                    
                    return csvContent;
                },
                
                convertJsonToHtmlTable(jsonData) {
                    if (!jsonData || (Array.isArray(jsonData) && jsonData.length === 0)) return '';
                    
                    // Déterminer les en-têtes
                    const headers = Array.isArray(jsonData) && jsonData.length > 0 ? 
                        Object.keys(jsonData[0]) : Object.keys(jsonData);
                    
                    // Créer l'en-tête HTML
                    let htmlContent = '<thead><tr>';
                    headers.forEach(header => {
                        htmlContent += `<th>${header}</th>`;
                    });
                    htmlContent += '</tr></thead><tbody>';
                    
                    // Ajouter les lignes de données
                    if (Array.isArray(jsonData)) {
                        jsonData.forEach(item => {
                            htmlContent += '<tr>';
                            headers.forEach(header => {
                                const value = item[header] !== null && item[header] !== undefined ? item[header] : '';
                                htmlContent += `<td>${value}</td>`;
                            });
                            htmlContent += '</tr>';
                        });
                    } else {
                        // Si c'est un objet unique
                        htmlContent += '<tr>';
                        headers.forEach(header => {
                            const value = jsonData[header] !== null && jsonData[header] !== undefined ? jsonData[header] : '';
                            htmlContent += `<td>${value}</td>`;
                        });
                        htmlContent += '</tr>';
                    }
                    
                    htmlContent += '</tbody>';
                    return htmlContent;
                }
            }
        }
    </script>
</body>
</html>